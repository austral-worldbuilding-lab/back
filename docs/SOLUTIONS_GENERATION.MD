# ğŸ¯ AI Solutions Generation Feature

## Overview

The AI Solutions Generation feature is a crucial component of the worldbuilding process that generates concrete, actionable solutions based on project encyclopedia content. This feature completes the worldbuilding pipeline by transforming identified problems into viable solutions.

## ğŸš€ Features

- **AI-Powered Solution Generation**: Uses Gemini AI to generate contextual solutions
- **Encyclopedia Integration**: Automatically generates and uses project encyclopedia as knowledge base
- **Asynchronous Processing**: Queue-based generation with real-time status tracking
- **Caching System**: Stores generated solutions in Redis cache for fast retrieval
- **Job Pipeline**: BullMQ-powered pipeline with dependency management
- **Impact Assessment**: Solutions include impact level and detailed impact descriptions

## ğŸ—ï¸ Architecture

### Core Components

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Solution       â”‚    â”‚  AI Strategy     â”‚    â”‚  Queue          â”‚
â”‚  Controller     â”‚â”€â”€â”€â–¶â”‚  Solutions       â”‚â”€â”€â”€â–¶â”‚  Solutions      â”‚
â”‚                 â”‚    â”‚  Strategy        â”‚    â”‚  Processor      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Solution       â”‚    â”‚  AI Prompt       â”‚    â”‚  Encyclopedia   â”‚
â”‚  Service        â”‚    â”‚  Builder         â”‚    â”‚  Queue Service  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cache          â”‚    â”‚  Gemini          â”‚    â”‚  BullMQ         â”‚
â”‚  Service        â”‚    â”‚  Adapter         â”‚    â”‚  Pipeline       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data Flow

1. **Request**: User triggers solution generation via API
2. **Queue**: Job is added to solutions queue
3. **Encyclopedia**: If needed, encyclopedia generation is triggered and waited for
4. **AI Generation**: Solutions are generated using project data and encyclopedia
5. **Caching**: Generated solutions are stored in Redis cache
6. **Response**: User can retrieve solutions from cache or check job status

## ğŸ“‹ API Endpoints

### Generate Solutions
```http
POST /project/{projectId}/solutions/generate
```

**Description**: Queues a job to generate AI-powered solutions for a project.

**Headers**:
```
Authorization: Bearer <firebase-token>
```

**Response**:
```json
{
  "jobId": "solutions-a1b2c3d4-e5f6-7890-1234-567890abcdef-1678886400000",
  "message": "Solutions generation job has been queued"
}
```

### Check Generation Status
```http
GET /project/{projectId}/solutions/generate/status
```

**Description**: Retrieves the status of the solutions generation job.

**Response**:
```json
{
  "jobId": "solutions-a1b2c3d4-e5f6-7890-1234-567890abcdef-1678886400000",
  "status": "completed",
  "progress": 100,
  "solutions": [
    {
      "title": "Sustainable Celebration Center",
      "description": "Creation of a dedicated space for graduation celebrations...",
      "problem": "Current celebrations generate disorder and environmental impact...",
      "impactLevel": "HIGH",
      "impactDescription": "This solution addresses multiple problems through dedicated infrastructure..."
    }
  ],
  "createdAt": "2023-03-15T10:00:00.000Z",
  "processedAt": "2023-03-15T10:05:00.000Z",
  "finishedAt": "2023-03-15T10:10:00.000Z"
}
```

### Get Cached Solutions
```http
GET /project/{projectId}/solutions/cached
```

**Description**: Retrieves previously generated solutions from cache.

**Response**:
```json
[
  {
    "title": "Sustainable Celebration Center",
    "description": "Creation of a dedicated space for graduation celebrations...",
    "problem": "Current celebrations generate disorder and environmental impact...",
    "impactLevel": "HIGH",
    "impactDescription": "This solution addresses multiple problems through dedicated infrastructure..."
  }
]
```

## ğŸ”„ Job Pipeline

### BullMQ Integration

The solutions generation uses BullMQ's native job pipeline features:

```typescript
// Job Dependency Chain
SolutionsJob => EncyclopediaJob => AIGeneration => CacheStorage
```


**Key Features**:
- **waitUntilFinished**: Native BullMQ dependency resolution
- **Event-driven**: Uses BullMQ's event system instead of polling
- **Retry Logic**: Automatic retry with exponential backoff
- **Job Cleanup**: Automatic cleanup of completed/failed jobs

### Job States

- `waiting`: Job queued, waiting for processing
- `active`: Job currently being processed
- `completed`: Job finished successfully
- `failed`: Job failed with error
- `delayed`: Job scheduled for later execution

## ğŸ’¾ Caching Strategy

### Cache Keys
```
ai:solutions:project:{projectId}
```

### Cache Configuration
- **Limit**: 20 solutions per cache key
- **TTL**: Managed by Redis configuration
- **Storage**: Individual solution objects in Redis list
- **Scope**: Project-global (shared across all users of the project)

### Cache Operations
- **Save**: `addToLimitedCache()` - Adds solutions to cache with limit
- **Retrieve**: `getFromCache()` - Retrieves all cached solutions
- **Management**: Automatic cleanup and size management
- **Key Strategy**: Project-based caching (not user-specific)

## ğŸ› ï¸ Implementation Details

### Key Files

```
src/modules/solution/
â”œâ”€â”€ solution.controller.ts          # API endpoints
â”œâ”€â”€ solution.service.ts             # Business logic
â”œâ”€â”€ decorators/
â”‚   â”œâ”€â”€ generate-solutions.decorator.ts
â”‚   â”œâ”€â”€ get-solutions-status.decorator.ts
â”‚   â””â”€â”€ get-cached-solutions.decorator.ts
â”œâ”€â”€ dto/
â”‚   â”œâ”€â”€ solutions-job-response.dto.ts
â”‚   â””â”€â”€ solutions-job-status.dto.ts
â””â”€â”€ types/
    â””â”€â”€ solutions.type.ts
src/modules/ai/
â”œâ”€â”€ strategies/solutions.strategy.ts    # AI strategy implementation
â”œâ”€â”€ resources/prompts/
â”‚   â””â”€â”€ prompt_generar_soluciones.txt   # Prompt template
â””â”€â”€ services/
    â””â”€â”€ ai-prompt-builder.service.ts    # Prompt building logic
src/modules/queue/
â”œâ”€â”€ services/solutions-queue.service.ts # Queue management
â”œâ”€â”€ processors/solutions.processor.ts   # Job processing
â””â”€â”€ types/solutions-job.types.ts        # Job type definitions
```

### Dependencies

- **Encyclopedia Generation**: Solutions always generate fresh encyclopedia
- **AI Service**: Uses Gemini AI with structured output
- **Cache Service**: Redis-based caching for performance
- **Project Service**: Project data and validation
- **Queue Service**: BullMQ for asynchronous processing

## ğŸš¦ Error Handling

### Common Error Scenarios

1. **Missing Encyclopedia**: Automatically generates encyclopedia
2. **AI Service Errors**: Retry with exponential backoff
3. **Cache Failures**: Graceful degradation, solutions still generated
4. **Queue Failures**: Job retry mechanism
5. **Validation Errors**: Clear error messages with validation details

### Error Response Format

```json
{
  "statusCode": 400,
  "message": "A solutions generation is already in progress for this project",
  "error": "Bad Request"
}
```

## ğŸ“Š Monitoring and Observability

### Logging

All operations are logged with structured logging:

```typescript
// Job lifecycle
this.logger.log(`Solutions job ${jobId} queued for project ${projectId}`);
this.logger.log(`Solutions job ${jobId} completed for project ${projectId}`);

// AI operations
this.logger.log(`Generated ${solutions.length} solutions for project: ${projectId}`);
```

### Metrics

- Job completion rates
- AI token usage tracking
- Cache hit/miss ratios
- Processing times

## ğŸ”’ Security and Permissions

### Authentication
- Firebase JWT token required
- User context validation

### Authorization
- Project role-based access control
- Required roles: `member`, `owner`, `admin`
- Project ownership validation

### Rate Limiting
- Throttled to 10 requests per hour per user
- Prevents abuse of AI generation resources
