generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "darwin", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                   @id @default(uuid())
  username               String                   @unique
  email                  String                   @unique
  fullName               String
  is_active              Boolean                  @default(true)
  projectRoles           UserProjectRole[]
  Invitation             Invitation[]
  organizationRoles      UserOrganizationRole[]
  OrganizationInvitation OrganizationInvitation[]
  AiUsage                AiUsage[]
}

model Project {
  id            String            @id @default(uuid())
  name          String
  icon          String    @default("folder")
  description   String?
  configuration Json // Contains dimensions[] and scales[]
  createdAt     DateTime          @default(now())
  isActive      Boolean           @default(true)
  deletedAt     DateTime?
  userRoles     UserProjectRole[] @relation("ProjectToUserRoles")
  mandalas      Mandala[]         @relation("ProjectToMandalas")
  Invitation    Invitation[]      @relation("ProjectToInvitations")
  tags          Tag[]

  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String
  AiUsage        AiUsage[]

  // project hierarchy useful for timeline
  parentProjectId String?
  parent          Project?  @relation("ProjParent", fields: [parentProjectId], references: [id], onDelete: SetNull)
  children        Project[] @relation("ProjParent")
  rootProjectId   String?
  rootProject     Project?  @relation("ProjRoot", fields: [rootProjectId], references: [id], onDelete: SetNull)
  rootChildren    Project[] @relation("ProjRoot")

  provocations ProjProvLink[]
  solutions    ProjSolLink[] // only the root project should have solutions

  @@index([parentProjectId])
  @@index([rootProjectId])
}

model Role {
  id                      String                   @id @default(uuid())
  name                    String                   @unique
  userRoles               UserProjectRole[]
  organizationRoles       UserOrganizationRole[]
  invitations             Invitation[]
  organizationInvitations OrganizationInvitation[]
}

model UserProjectRole {
  id        String  @id @default(uuid())
  user      User    @relation(fields: [userId], references: [id])
  userId    String
  project   Project @relation("ProjectToUserRoles", fields: [projectId], references: [id], onDelete: Cascade)
  projectId String
  role      Role    @relation(fields: [roleId], references: [id])
  roleId    String

  @@unique([userId, projectId]) // This allows for a user to have multiple roles in project
}

model Mandala {
  id            String      @id @default(uuid())
  name          String
  type          MandalaType @default(CHARACTER)
  configuration Json // Contains centerCharacter, dimensions[] and scales[]
  project       Project     @relation("ProjectToMandalas", fields: [projectId], references: [id], onDelete: Cascade)
  projectId     String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  isActive      Boolean     @default(true)
  deletedAt     DateTime?

  children Mandala[] @relation("MandalaToMandala")
  parent   Mandala[] @relation("MandalaToMandala")
}

model Invitation {
  id          String           @id @default(uuid())
  email       String?
  token       String           @unique
  inviteToken String?          @unique
  status      InvitationStatus @default(PENDING)
  expiresAt   DateTime
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  project   Project @relation("ProjectToInvitations", fields: [projectId], references: [id], onDelete: Cascade)
  projectId String

  invitedBy   User   @relation(fields: [invitedById], references: [id])
  invitedById String

  role   Role?   @relation(fields: [roleId], references: [id])
  roleId String?

  @@unique([email, projectId])
  @@index([inviteToken])
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

enum MandalaType {
  CHARACTER
  OVERLAP
  OVERLAP_SUMMARY
  CONTEXT
}

model Tag {
  id        String    @id @default(uuid())
  name      String
  color     String
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String
  isActive  Boolean   @default(true)
  deletedAt DateTime?

  @@unique([name, projectId, isActive])
}

model Organization {
  id        String    @id @default(uuid())
  name      String
  icon      String    @default("building-2")
  createdAt DateTime  @default(now())
  isActive  Boolean   @default(true)
  deletedAt DateTime?

  projects                Project[]
  userRoles               UserOrganizationRole[]
  organizationInvitations OrganizationInvitation[] @relation("OrganizationToInvitations")
  AiUsage                 AiUsage[]
}

model UserOrganizationRole {
  id             String       @id @default(uuid())
  user           User         @relation(fields: [userId], references: [id])
  userId         String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String
  role           Role         @relation(fields: [roleId], references: [id])
  roleId         String

  @@unique([userId, organizationId])
}

model OrganizationInvitation {
  id          String           @id @default(uuid())
  email       String?
  token       String           @unique
  inviteToken String?          @unique
  status      InvitationStatus @default(PENDING)
  expiresAt   DateTime
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  organization   Organization @relation("OrganizationToInvitations", fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String

  invitedBy   User   @relation(fields: [invitedById], references: [id])
  invitedById String // quien manda la invitación

  role   Role?   @relation(fields: [roleId], references: [id])
  roleId String? // rol que tendrá el usuario invitado

  @@unique([email, organizationId])
  @@index([inviteToken])
}

enum AiService {
  GENERATE_POSTITS
  GENERATE_QUESTIONS
  GENERATE_SUMMARY
  GENERATE_PROVOCATIONS
  GENERATE_ENCYCLOPEDIA
  GENERATE_SOLUTIONS
  GENERATE_MANDALA_IMAGES
}

enum AiModel {
  GEMINI_25_FLASH
}

model AiUsage {
  id        String   @id @default(uuid())
  timestamp DateTime @default(now())

  service AiService
  model   AiModel

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  quantity Int // tokens consumed

  @@index([userId, timestamp])
  @@index([service, timestamp])
  @@index([model, timestamp])
  @@index([projectId, timestamp])
  @@index([organizationId, timestamp])
}

model Provocation {
  id String @id @default(uuid())

  parentProvocationId String?
  parent              Provocation?  @relation("ProvParent", fields: [parentProvocationId], references: [id], onDelete: SetNull)
  children            Provocation[] @relation("ProvParent")

  question String
  content  Json? // title, description

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  isActive  Boolean   @default(true)
  deletedAt DateTime?

  projects  ProjProvLink[]
  solutions SolProvLink[]

  @@index([parentProvocationId])
}

enum ProjProvLinkRole {
  ORIGIN // PROVOCATION_ORIGINATES_PROJECT
  GENERATED // PROJECT_GENERATES_PROVOCATION
  REFERENCE
}

enum ImpactLevel {
  LOW
  MEDIUM
  HIGH
}

enum ProjSolLinkRole {
  GENERATED // PROJECT_GENERATES_SOLUTION
  REFERENCE
}

model ProjProvLink {
  id            String      @id @default(uuid())
  projectId     String
  project       Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  provocationId String
  provocation   Provocation @relation(fields: [provocationId], references: [id], onDelete: Cascade)

  role      ProjProvLinkRole
  createdAt DateTime         @default(now())

  @@unique([projectId, provocationId, role])
  @@index([provocationId, role])
  @@index([projectId, role])
}

model FileSelection {
  id          String   @id @default(uuid())
  contextPath String // /org/orgId/project/projectId/mandala/mandalaId
  fileName    String
  selected    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orgId     String
  projectId String?
  mandalaId String?

  @@unique([contextPath, fileName])
  @@index([orgId])
  @@index([orgId, projectId])
  @@index([orgId, projectId, mandalaId])
  @@index([contextPath])
  @@map("file_selections")
}

model Solution {
  id String @id @default(uuid())

  title       String
  description String
  problem     String

  impactLevel       ImpactLevel?
  impactDescription String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  isActive  Boolean   @default(true)
  deletedAt DateTime?

  projects     ProjSolLink[]
  provocations SolProvLink[]
}

model ProjSolLink {
  id         String   @id @default(uuid())
  projectId  String
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  solutionId String
  solution   Solution @relation(fields: [solutionId], references: [id], onDelete: Cascade)

  role      ProjSolLinkRole
  createdAt DateTime        @default(now())

  @@unique([projectId, solutionId, role])
  @@index([solutionId, role])
  @@index([projectId, role])
}

model SolProvLink {
  id            String      @id @default(uuid())
  solutionId    String
  solution      Solution    @relation(fields: [solutionId], references: [id], onDelete: Cascade)
  provocationId String
  provocation   Provocation @relation(fields: [provocationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([solutionId, provocationId])
  @@index([solutionId])
  @@index([provocationId])
}

model GeminiFileCache {
  id String @id @default(uuid())

  fileName    String
  fileHash    String
  contextPath String

  // IDs de Gemini para reutilizar
  geminiFileId String
  geminiUri    String

  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([contextPath, fileName])
  @@index([expiresAt])
  @@map("gemini_file_cache")
}
