generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "darwin", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String                 @id @default(uuid())
  username          String                 @unique
  email             String                 @unique
  is_active         Boolean                @default(true)
  projectRoles      UserProjectRole[]
  Invitation        Invitation[]
  organizationRoles UserOrganizationRole[]
}

model Project {
  id            String            @id @default(uuid())
  name          String
  description   String?
  configuration Json // Contains dimensions[] and scales[]
  createdAt     DateTime          @default(now())
  isActive      Boolean           @default(true)
  deletedAt     DateTime?
  userRoles     UserProjectRole[] @relation("ProjectToUserRoles")
  mandalas      Mandala[]         @relation("ProjectToMandalas")
  Invitation    Invitation[]      @relation("ProjectToInvitations")
  tags          Tag[]

  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String
}

model Role {
  id                String                 @id @default(uuid())
  name              String                 @unique
  userRoles         UserProjectRole[]
  organizationRoles UserOrganizationRole[]
  invitations       Invitation[]
}

model UserProjectRole {
  id        String  @id @default(uuid())
  user      User    @relation(fields: [userId], references: [id])
  userId    String
  project   Project @relation("ProjectToUserRoles", fields: [projectId], references: [id], onDelete: Cascade)
  projectId String
  role      Role    @relation(fields: [roleId], references: [id])
  roleId    String

  @@unique([userId, projectId]) // This allows for a user to have multiple roles in project
}

model Mandala {
  id            String    @id @default(uuid())
  name          String
  configuration Json // Contains centerCharacter, dimensions[] and scales[]
  project       Project   @relation("ProjectToMandalas", fields: [projectId], references: [id], onDelete: Cascade)
  projectId     String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  isActive      Boolean   @default(true)
  deletedAt     DateTime?

  children Mandala[] @relation("MandalaToMandala")
  parent   Mandala[] @relation("MandalaToMandala")
}

model Invitation {
  id          String           @id @default(uuid())
  email       String?
  token       String           @unique
  inviteToken String?          @unique
  status      InvitationStatus @default(PENDING)
  expiresAt   DateTime
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  project   Project @relation("ProjectToInvitations", fields: [projectId], references: [id], onDelete: Cascade)
  projectId String

  invitedBy   User   @relation(fields: [invitedById], references: [id])
  invitedById String

  role   Role?   @relation(fields: [roleId], references: [id])
  roleId String?

  @@unique([email, projectId])
  @@index([inviteToken])
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

model Tag {
  id        String    @id @default(uuid())
  name      String
  color     String    @default(dbgenerated("'#' || lpad(to_hex((random() * 16777215)::int), 6, '0')"))
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String
  isActive  Boolean   @default(true)
  deletedAt DateTime?

  @@unique([name, projectId, isActive])
}

model Organization {
  id        String    @id @default(uuid())
  name      String
  createdAt DateTime  @default(now())
  isActive  Boolean   @default(true)
  deletedAt DateTime?

  projects  Project[]
  userRoles UserOrganizationRole[]
}

model UserOrganizationRole {
  id             String       @id @default(uuid())
  user           User         @relation(fields: [userId], references: [id])
  userId         String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String
  role           Role         @relation(fields: [roleId], references: [id])
  roleId         String

  @@unique([userId, organizationId])
}
