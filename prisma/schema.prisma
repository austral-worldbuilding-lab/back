generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "darwin", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                   @id @default(uuid())
  username               String                   @unique
  email                  String                   @unique
  is_active              Boolean                  @default(true)
  fullName               String
  AiUsage                AiUsage[]
  Invitation             Invitation[]
  OrganizationInvitation OrganizationInvitation[]
  organizationRoles      UserOrganizationRole[]
  projectRoles           UserProjectRole[]
}

model Project {
  id              String                   @id @default(uuid())
  name            String
  createdAt       DateTime                 @default(now())
  configuration   Json
  deletedAt       DateTime?
  isActive        Boolean                  @default(true)
  organizationId  String
  description     String?
  parentProjectId String?
  rootProjectId   String
  AiUsage         AiUsage[]
  Invitation      Invitation[]             @relation("ProjectToInvitations")
  mandalas        Mandala[]                @relation("ProjectToMandalas")
  organization    Organization             @relation(fields: [organizationId], references: [id])
  parent          Project?                 @relation("ProjParent", fields: [parentProjectId], references: [id])
  children        Project[]                @relation("ProjParent")
  rootProject     Project                  @relation("ProjRoot", fields: [rootProjectId], references: [id], onDelete: Cascade)
  rootChildren    Project[]                @relation("ProjRoot")
  provocations    ProjectProvocationLink[]
  tags            Tag[]
  userRoles       UserProjectRole[]        @relation("ProjectToUserRoles")

  @@index([parentProjectId])
  @@index([rootProjectId])
}

model Role {
  id                      String                   @id @default(uuid())
  name                    String                   @unique
  invitations             Invitation[]
  organizationInvitations OrganizationInvitation[]
  organizationRoles       UserOrganizationRole[]
  userRoles               UserProjectRole[]
}

model UserProjectRole {
  id        String  @id @default(uuid())
  userId    String
  projectId String
  roleId    String
  project   Project @relation("ProjectToUserRoles", fields: [projectId], references: [id], onDelete: Cascade)
  role      Role    @relation(fields: [roleId], references: [id])
  user      User    @relation(fields: [userId], references: [id])

  @@unique([userId, projectId])
}

model Mandala {
  id            String      @id @default(uuid())
  name          String
  type          MandalaType @default(CHARACTER)
  configuration Json // Contains centerCharacter, dimensions[] and scales[]
  project       Project     @relation("ProjectToMandalas", fields: [projectId], references: [id], onDelete: Cascade)
  projectId     String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  isActive      Boolean     @default(true)
  deletedAt     DateTime?

  children Mandala[] @relation("MandalaToMandala")
  parent   Mandala[] @relation("MandalaToMandala")
}

model Invitation {
  id          String           @id @default(uuid())
  email       String?
  status      InvitationStatus @default(PENDING)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  projectId   String
  invitedById String
  expiresAt   DateTime
  roleId      String?
  token       String           @unique
  inviteToken String?          @unique
  invitedBy   User             @relation(fields: [invitedById], references: [id])
  project     Project          @relation("ProjectToInvitations", fields: [projectId], references: [id], onDelete: Cascade)
  role        Role?            @relation(fields: [roleId], references: [id])

  @@unique([email, projectId])
  @@index([inviteToken])
}

model Tag {
  id        String    @id @default(uuid())
  name      String
  color     String    @default(dbgenerated("('#'::text || lpad(to_hex(((random() * (16777215)::double precision))::integer), 6, '0'::text))"))
  projectId String
  deletedAt DateTime?
  isActive  Boolean   @default(true)
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([name, projectId, isActive])
}

model Organization {
  id                      String                   @id @default(uuid())
  name                    String
  createdAt               DateTime                 @default(now())
  isActive                Boolean                  @default(true)
  deletedAt               DateTime?
  AiUsage                 AiUsage[]
  organizationInvitations OrganizationInvitation[] @relation("OrganizationToInvitations")
  projects                Project[]
  userRoles               UserOrganizationRole[]
}

model UserOrganizationRole {
  id             String       @id @default(uuid())
  userId         String
  organizationId String
  roleId         String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role           Role         @relation(fields: [roleId], references: [id])
  user           User         @relation(fields: [userId], references: [id])

  @@unique([userId, organizationId])
}

model OrganizationInvitation {
  id             String           @id @default(uuid())
  email          String?
  token          String           @unique
  inviteToken    String?          @unique
  status         InvitationStatus @default(PENDING)
  expiresAt      DateTime
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  organizationId String
  invitedById    String
  roleId         String?
  invitedBy      User             @relation(fields: [invitedById], references: [id])
  organization   Organization     @relation("OrganizationToInvitations", fields: [organizationId], references: [id], onDelete: Cascade)
  role           Role?            @relation(fields: [roleId], references: [id])

  @@unique([email, organizationId])
  @@index([inviteToken])
}

model AiUsage {
  id             String        @id @default(uuid())
  timestamp      DateTime      @default(now())
  service        AiService
  model          AiModel
  userId         String
  quantity       Int
  organizationId String?
  projectId      String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  project        Project?      @relation(fields: [projectId], references: [id])
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, timestamp])
  @@index([service, timestamp])
  @@index([model, timestamp])
  @@index([projectId, timestamp])
  @@index([organizationId, timestamp])
}

model Provocation {
  id                  String                   @id @default(uuid())
  parentProvocationId String?
  question            String
  content             Json?
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt
  isActive            Boolean                  @default(true)
  deletedAt           DateTime?
  projects            ProjectProvocationLink[]
  parent              Provocation?             @relation("ProvParent", fields: [parentProvocationId], references: [id])
  children            Provocation[]            @relation("ProvParent")

  @@index([parentProvocationId])
}

model ProjectProvocationLink {
  id            String           @id @default(uuid())
  projectId     String
  provocationId String
  role          ProjProvLinkRole
  createdAt     DateTime         @default(now())
  project       Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  provocation   Provocation      @relation(fields: [provocationId], references: [id], onDelete: Cascade)

  @@unique([projectId, provocationId, role])
  @@index([provocationId, role])
  @@index([projectId, role])
}

model FileSelection {
  id          String   @id @default(uuid())
  orgId       String
  projectId   String?
  mandalaId   String?
  fileName    String
  selected    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  contextPath String

  @@unique([contextPath, fileName])
  @@index([orgId])
  @@index([orgId, projectId])
  @@index([orgId, projectId, mandalaId])
  @@index([contextPath])
  @@map("file_selections")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

enum MandalaType {
  CHARACTER
  OVERLAP
  OVERLAP_SUMMARY
}

enum AiService {
  GENERATE_POSTITS
  GENERATE_QUESTIONS
  GENERATE_SUMMARY
  GENERATE_PROVOCATIONS
  GENERATE_ENCYCLOPEDIA
}

enum AiModel {
  GEMINI_25_FLASH
}

enum ProjProvLinkRole {
  ORIGIN
  GENERATED
  REFERENCE
}
